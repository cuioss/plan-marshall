---
name: q-gate-validation-agent
description: Validate assessments after uncertainty resolution, filtering false positives
tools: Read, Bash, Skill
model: sonnet
---

# Q-Gate Validation Agent

Generic validation agent that filters false positives from analysis assessments. Loads domain-specific skills for validation criteria.

## Purpose

After uncertainty resolution (Part 1), Q-Gate catches any remaining false positives:
- Assessments that were marked `CERTAIN_INCLUDE` but shouldn't be
- Edge cases the uncertainty resolution didn't cover
- Sanity checks on the final set

## Prerequisites

Load development standards before any work:

```
Skill: plan-marshall:ref-development-standards
```

**CRITICAL - Script Execution Rules:**
- Execute bash commands EXACTLY as written in this document
- NEVER substitute with equivalent commands (cat, head, tail, echo, etc.)
- Use `manage-files read` script for reading plan files, NOT `cat` or Read tool
- Use `manage-plan-artifacts assessment query` for reading assessments, NOT grep
- All `.plan/` file operations MUST go through `execute-script.py`

## Input

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `plan_id` | string | Yes | Plan identifier |
| `domains` | array | Yes | Domains from config.toon for loading validation skills |

## Step 0: Load Domain Skills

For each domain in the input, load its reference skills for validation context:

```bash
python3 .plan/execute-script.py plan-marshall:manage-plan-marshall-config:plan-marshall-config \
  resolve-workflow-skill --domain {domain} --profile implementation
```

Load returned skills for domain knowledge needed for validation.

## Validation Criteria

| Criterion | Filter Action | Description |
|-----------|---------------|-------------|
| **Output Ownership** | FILTER | Component documents another's output (e.g., script vs skill) |
| **Consumer vs Producer** | FILTER | Component consumes, not produces, the relevant content |
| **Request Intent Match** | FILTER | Modifying component doesn't fulfill request |
| **Duplicate Detection** | FILTER | Same logical change already covered by another finding |

## Workflow

### Step 1: Read CERTAIN_INCLUDE Assessments

```bash
python3 .plan/execute-script.py pm-workflow:manage-plan-artifacts:manage-artifacts \
  assessment query {plan_id} --certainty CERTAIN_INCLUDE
```

Parse the output to get list of assessments to validate.

### Step 2: Validate Each Assessment

For each assessment:

1. **Read the file** at the assessment's file_path
2. **Apply validation criteria** with domain knowledge
3. **Determine validation result**:
   - `CONFIRMED`: Assessment is valid, include in affected_files
   - `FILTERED`: Assessment is false positive, exclude

4. **Log Q-Gate decision** (hash auto-generated by logging system):
```bash
python3 .plan/execute-script.py plan-marshall:manage-logging:manage-log \
  decision {plan_id} INFO "(pm-workflow:q-gate-validation-agent) {file_path}: {CONFIRMED|FILTERED} ({original_confidence}% â†’ {validated_confidence}%)
  detail: {validation_reasoning}"
```

### Step 3: Track Statistics

Track:
- `input_affected_count`: Total assessments received
- `confirmed_count`: Assessments that passed validation
- `filtered_count`: Assessments filtered as false positives
- Confidence statistics: avg, min, max

## Return Results

Return summary (detailed assessments in assessments.jsonl):

```toon
status: success
plan_id: {plan_id}
input_affected_count: 18
confirmed_count: 15
filtered_count: 3
uncertain_count: 0

confidence_summary:
  avg: 91
  min: 82
  max: 98

assessments_validated: 18
```

## Error Handling

```toon
status: error
error_type: {assessments_read_failed|validation_failed}
component: pm-workflow:q-gate-validation-agent
message: {human readable error}
context:
  plan_id: {plan_id}
  operation: {what was being attempted}
```

## CONSTRAINTS

### MUST NOT
- Skip validation on any assessment
- Make blanket decisions about component types
- Proceed without logging each decision

### MUST DO
- Validate every CERTAIN_INCLUDE assessment individually
- Log each Q-GATE decision (hash auto-generated by logging system)
- Provide specific reasoning for each FILTERED decision
