# Module Configuration

Project module management with domain and build system mappings using static routing.

## Purpose

Modules represent distinct parts of a project with different:
- Skill domains (Java, JavaScript, testing)
- Build systems (Maven, npm, Gradle)
- Command configurations (full executable strings)

## Static Routing Pattern

Commands are stored as **full executable strings** in `modules.{name}.commands`:

```json
{
  "modules": {
    "default": {
      "path": ".",
      "domains": ["java"],
      "build_systems": ["maven"],
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\"",
        "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\""
      }
    },
    "my-module": {
      "path": "my-module",
      "domains": ["java"],
      "build_systems": ["maven"],
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\" --module my-module",
        "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\" --module my-module"
      }
    }
  }
}
```

## Fields

### path

Relative path from project root to the module.

```json
"path": "modules/my-module"
```

### domains

Skill domains applicable to this module. Links to `skill_domains` configuration.

```json
"domains": ["java"]
```

Standard domains:
- `java` - Java development (nested structure with core/implementation/testing)
- `javascript` - JavaScript development (nested structure with core/implementation/testing)

### build_systems

Available build systems for this module. Used for detection reference.

```json
"build_systems": ["maven", "npm"]
```

### commands

Full executable command strings for each label.

```json
"commands": {
  "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\"",
  "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\"",
  "pre-commit": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean install\" --profile pre-commit"
}
```

## Command Resolution

When requesting a command for a module:

1. **Check module commands first**
   ```
   modules.{module}.commands.{label}
   ```

2. **Fall back to default module**
   ```
   modules.default.commands.{label}
   ```

### Example

```bash
# Get verify command for my-module
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules get-command --module my-module --label verify
```

**Output**:
```toon
status: success
module: my-module
label: verify
command: python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets "clean verify" --module my-module
source: module
```

If `modules.my-module.commands.verify` exists → returns module-specific command
Otherwise → returns `modules.default.commands.verify`

## Command Generation

Commands are generated by the `build_env persist` workflow:

```bash
python3 .plan/execute-script.py plan-marshall:extension-api:build_env persist
```

This:
1. Detects build systems
2. Detects modules
3. Generates full command strings
4. Persists to marshal.json

### Generated Command Format

| Build System | Format |
|--------------|--------|
| Maven | `python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets "{goals}" [--module {module}] [--profile {profile}]` |
| Gradle | `python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:gradle run --targets "{tasks}" [--project {module}]` |
| npm | `python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command "{command}" [--module {module}]` |

## Module Detection

Auto-detect modules from build files:

```bash
python3 .plan/execute-script.py plan-marshall:extension-api:build_env detect-modules
```

### Detection Sources

| Build System | Source File | Detection Method |
|--------------|-------------|------------------|
| Maven | pom.xml | Parse `<modules>` section |
| Gradle | settings.gradle.kts | Parse `include` statements |
| npm | package.json | Parse `workspaces` |

## Usage Patterns

### Get Skills for Module

```bash
# Get domains for module
domains=$(python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules get-domains --module my-ui)

# Resolve skills for domain and profile
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  resolve-domain-skills --domain java --profile implementation
```

### Get Build Command

```bash
# Get verify command (static routing)
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules get-command --module my-ui --label verify
```

### Set Custom Command

```bash
# Set custom command for module
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules set-command --module my-ui --label verify \
  --command 'python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command "run lint && run test"'
```

### Add Module

```bash
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules add \
  --module new-e2e \
  --path tests/e2e \
  --domains "javascript" \
  --build-systems "npm"
```

## Multi-Module Project Example

```json
{
  "modules": {
    "default": {
      "path": ".",
      "domains": ["java"],
      "build_systems": ["maven"],
      "commands": {
        "test-compile": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"test-compile\"",
        "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\"",
        "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\"",
        "install": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean install\"",
        "pre-commit": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean install\" --profile pre-commit"
      }
    },
    "core-api": {
      "path": "core-api",
      "domains": ["java"],
      "build_systems": ["maven"],
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\" --module core-api",
        "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\" --module core-api"
      }
    },
    "web-ui": {
      "path": "web-ui",
      "domains": ["javascript"],
      "build_systems": ["npm"],
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command \"run test\"",
        "build": "python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command \"run build\""
      }
    },
    "e2e-tests": {
      "path": "e2e-tests",
      "domains": ["javascript"],
      "build_systems": ["npm"],
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command \"run cypress:run\"",
        "verify": "python3 .plan/execute-script.py pm-dev-frontend:plan-marshall-plugin:npm execute --command \"run cypress:run\""
      }
    }
  }
}
```

## Static Routing Benefits

1. **Transparency**: Config shows exactly what runs
2. **Customization**: User can edit any command directly
3. **No runtime logic**: Command already contains correct script path
4. **Single mental model**: Same pattern as CI commands

## Agent Usage

Implementation agents use module configuration to:

1. **Determine applicable skills**
   ```
   modules get-domains → resolve-domain-skills
   ```

2. **Run correct build commands**
   ```
   modules get-command --module X --label Y
   eval "$COMMAND"
   ```

3. **Scope verification to module**
   - Command includes `--module {module-path}` flag
   - Script handles module-specific execution
