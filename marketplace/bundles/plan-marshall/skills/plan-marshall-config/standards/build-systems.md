# Build Systems

Build system detection reference. Commands are stored in modules using static routing.

## Purpose

Build systems section provides:
- Detection reference for available build systems
- Skill association for build execution
- Wizard setup reference

**Note**: Commands are NOT stored in `build_systems`. Commands are stored in `modules.{name}.commands` using static routing pattern.

## Structure

```json
{
  "build_systems": [
    {
      "system": "maven",
      "skill": "pm-dev-java:plan-marshall-plugin"
    },
    {
      "system": "npm",
      "skill": "pm-dev-java:plan-marshall-plugin"
    }
  ]
}
```

## Fields

### system

Build system identifier.

| Value | Description |
|-------|-------------|
| `maven` | Apache Maven |
| `gradle` | Gradle Build |
| `npm` | Node Package Manager |

### skill

Skill that handles build execution for this system.

| System | Skill |
|--------|-------|
| maven | `pm-dev-java:plan-marshall-plugin` |
| gradle | `pm-dev-java:plan-marshall-plugin` |
| npm | `pm-dev-frontend:plan-marshall-plugin` |

## Detection

Auto-detect build systems from project files:

```bash
python3 .plan/execute-script.py plan-marshall:extension-api:build_env detect
```

### Detection Rules

| File Present | Detected System |
|--------------|-----------------|
| `pom.xml` | maven |
| `build.gradle` or `build.gradle.kts` | gradle |
| `package.json` | npm |

## Standard Command Labels

Commands are generated by `build_env persist` and stored in modules. Standard labels:

| Label | Purpose | Maven Goals | Gradle Tasks | npm Scripts |
|-------|---------|-------------|--------------|-------------|
| `test-compile` | Compile tests | `test-compile` | `testClasses` | - |
| `test` | Run unit tests | `clean test` | `clean test` | `run test` |
| `verify` | Full verification | `clean verify` | `clean build` | `run test && npm run lint` |
| `install` | Install artifacts | `clean install` | `publishToMavenLocal` | - |
| `pre-commit` | Pre-commit checks | `clean install -Ppre-commit` | `clean build` | `run test` |
| `coverage` | Coverage analysis | `clean verify -Pcoverage` | `clean test jacocoTestReport` | `run test:coverage` |
| `build` | Build only | - | - | `run build` |
| `lint` | Linting only | - | - | `run lint` |

## Command Generation

The `build_env persist` command generates full command strings:

```bash
python3 .plan/execute-script.py plan-marshall:extension-api:build_env persist
```

This populates `modules.{name}.commands` with executable strings:

```json
{
  "modules": {
    "default": {
      "commands": {
        "test": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean test\"",
        "verify": "python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets \"clean verify\""
      }
    }
  }
}
```

## Usage Patterns

### Get Command for Build

Commands are retrieved from modules, not build-systems:

```bash
# Get verify command for module
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules get-command --module default --label verify
```

### List Build Systems

```bash
# List available systems (detection reference)
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  build-systems list
```

### Add Build System

```bash
# Add Gradle to detection reference
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  build-systems add --system gradle
```

## Build System Priority

When multiple systems detected, priority order:

| Priority | System | Technology |
|----------|--------|------------|
| 1 | maven | Java |
| 2 | gradle | Java |
| 3 | npm | JavaScript |

## Customizing Commands

### Module-Level (Recommended)

Edit `modules.{name}.commands` directly or use `set-command`:

```bash
python3 .plan/execute-script.py plan-marshall:plan-marshall-config:plan-marshall-config \
  modules set-command --module my-module --label verify \
  --command 'python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets "clean verify -DskipITs"'
```

### Regenerate Commands

Re-run persist to regenerate standard commands:

```bash
python3 .plan/execute-script.py plan-marshall:extension-api:build_env persist
```

## Integration with Build Operations

The extension-api and domain plugins provide:

1. **Detection**: `plan-marshall:extension-api:build_env detect` - Detect available systems
2. **Module Detection**: `plan-marshall:extension-api:build_env detect-modules` - Detect project modules
3. **Command Generation**: `plan-marshall:extension-api:build_env persist` - Generate and save commands
4. **Execution**: `pm-dev-java:plan-marshall-plugin:maven run` / `pm-dev-frontend:plan-marshall-plugin:npm run` - Execute builds

## Execution Flow

```
1. Get command from config:
   modules get-command --module X --label Y

2. Execute command directly:
   eval "$COMMAND"

3. Command invokes build script:
   python3 .plan/execute-script.py pm-dev-java:plan-marshall-plugin:maven run --targets "..."
```

## Static Routing vs Dynamic Routing

| Aspect | Static Routing (Current) | Dynamic Routing (Previous) |
|--------|-------------------------|---------------------------|
| Command Storage | `modules.{name}.commands.{label}` | `build_systems[].commands.{label}` |
| Resolution | Direct lookup | Runtime construction |
| Customization | Edit config directly | Complex override logic |
| Transparency | Full command visible | Abstract labels |
| Module Support | Built into command | Required runtime logic |
